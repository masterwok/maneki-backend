name: Deploy to Synology NAS

on:
  push:
    branches:
      - main

env:
  IMAGE_TAG: maneki:${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Install sshpass
      run: sudo apt-get install -y sshpass
    
    - name: Checkout code
      uses: actions/checkout@v2
      
    - uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Build and push
      uses: docker/build-push-action@v3
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository }}:${{ github.sha }}       

    - name: Load Docker image on Synology NAS
      uses: matheusvanzan/sshpass-action@v2
      with:
        port: 2222
        user: ${{ secrets.SYNOLOGY_USERNAME }}
        host: ${{ secrets.SYNOLOGY_HOST }}
        pass: ${{ secrets.SYNOLOGY_PASSWORD }}  
        run: |
          export PATH="$PATH:/usr/local/bin"
          
          echo "Logging into ghcr.io"
          echo "${{ secrets.GITHUB_TOKEN }}" |  docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "Pulling docker container ghcr.io/${{ github.repository }}:${{ github.sha }}"
          docker pull ghcr.io/${{ github.repository }}:${{ github.sha }}
          
          echo "Stop running container"
          docker stop maneki || true

          echo "Remove old container"
          docker rm maneki || true

          echo "Run new container"
          docker run \
            -d \
            --name=maneki \
            --restart unless-stopped \
            --log-opt max-size=5m \
            --log-opt max-file=3 \
            ghcr.io/${{ github.repository }}:${{ github.sha }}

        

      
